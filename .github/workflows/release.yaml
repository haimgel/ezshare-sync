name: release
on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

jobs:
  goreleaser:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && startsWith(github.event.workflow_run.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
    steps:
      - name: Checkout triggering commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c #v6.1.0
        with:
          go-version: '^1.25.0'
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a #v6.4.0
        with:
          distribution: goreleaser
          version: 2.13.2
          args: release --clean
        env:
          # This needs write access to the brew tap repo
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Generate build attestation for artifacts
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 #v3.1.0
        with:
          subject-path: './dist/ezshare-sync_*.{gz,apk,deb,rpm}'
